name: Tests & Coverage Report

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð±ÐµÐ¹Ð´Ð¶Ð°Ð¼Ð¸
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests with HTML Reporter
      id: run-tests
      run: npm run test:report
      continue-on-error: true  # ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¸ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð°Ñ…
        
    - name: Determine test status
      id: test-status
      run: |
        if [ "${{ steps.run-tests.outcome }}" == "success" ]; then
          echo "status=PASSED" >> $GITHUB_OUTPUT
          echo "emoji=âœ…" >> $GITHUB_OUTPUT
          echo "color=success" >> $GITHUB_OUTPUT
        else
          echo "status=FAILED" >> $GITHUB_OUTPUT
          echo "emoji=âŒ" >> $GITHUB_OUTPUT
          echo "color=critical" >> $GITHUB_OUTPUT
        fi
      
    - name: Generate badge for test status
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: <your-gist-id-here> # Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Gist Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾ ID
        filename: test-status.json
        label: tests
        message: ${{ steps.test-status.outputs.status }}
        color: ${{ steps.test-status.outputs.color }}
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: |
          ./coverage
          ./jest_html_reporters.html
          
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: .
        branch: gh-pages
        clean: false
        clean-exclude: |
          .gitignore
          README.md
        target-folder: reports/${{ github.run_number }} # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
    
    - name: Create latest symlink
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: ./reports/${{ github.run_number }}
        branch: gh-pages
        clean: true
        target-folder: reports/latest
    
    - name: Get deployment URL
      id: deployment
      run: |
        echo "REPORT_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/latest/jest_html_reporters.html" >> $GITHUB_OUTPUT
        echo "COVERAGE_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/latest/coverage/lcov-report/index.html" >> $GITHUB_OUTPUT
        echo "HISTORY_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/" >> $GITHUB_OUTPUT
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const reportUrl = '${{ steps.deployment.outputs.REPORT_URL }}';
          const coverageUrl = '${{ steps.deployment.outputs.COVERAGE_URL }}';
          const historyUrl = '${{ steps.deployment.outputs.HISTORY_URL }}';
          const status = '${{ steps.test-status.outputs.status }}';
          const emoji = '${{ steps.test-status.outputs.emoji }}';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ ${emoji}
            
            Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ñ‚ÐµÑÑ‚Ð¾Ð²: **${status}**
            
            ### Ð¡ÑÑ‹Ð»ÐºÐ¸:
            - [ðŸ“Š ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚](${reportUrl})
            - [ðŸ”Ž ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð°](${coverageUrl})
            - [ðŸ•’ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²](${historyUrl})
            
            > Ð­Ñ‚Ð¾Ñ‚ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð±Ñ‹Ð» ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð² GitHub Actions. Run #${{ github.run_number }}`
          })
    
    - name: Comment on commit
      if: github.event_name == 'push'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const reportUrl = '${{ steps.deployment.outputs.REPORT_URL }}';
          const coverageUrl = '${{ steps.deployment.outputs.COVERAGE_URL }}';
          const historyUrl = '${{ steps.deployment.outputs.HISTORY_URL }}';
          const status = '${{ steps.test-status.outputs.status }}';
          const emoji = '${{ steps.test-status.outputs.emoji }}';
          
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `## ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ ${emoji}
            
            Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ñ‚ÐµÑÑ‚Ð¾Ð²: **${status}**
            
            ### Ð¡ÑÑ‹Ð»ÐºÐ¸:
            - [ðŸ“Š ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚](${reportUrl})
            - [ðŸ”Ž ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð°](${coverageUrl})
            - [ðŸ•’ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²](${historyUrl})
            
            > Ð­Ñ‚Ð¾Ñ‚ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð±Ñ‹Ð» ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð² GitHub Actions. Run #${{ github.run_number }}`
          })
          
  # Ð”Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ²Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ÑÐ¾ Ð²ÑÐµÐ¼Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°Ð¼Ð¸
  index-page:
    needs: test-and-report
    runs-on: ubuntu-latest
    if: success() || failure()
    
    steps:
    - name: Checkout gh-pages
      uses: actions/checkout@v3
      with:
        ref: gh-pages
    
    - name: Generate index page
      run: |
        cat > index.html << EOL
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Test Reports Index</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            body { padding: 2rem; }
            .header { margin-bottom: 2rem; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>Test Reports Dashboard</h1>
              <p class="lead">Repository: ${{ github.repository }}</p>
            </div>
            
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0">Latest Report</h2>
              </div>
              <div class="card-body">
                <a href="./reports/latest/jest_html_reporters.html" class="btn btn-primary">View Latest Test Report</a>
                <a href="./reports/latest/coverage/lcov-report/index.html" class="btn btn-info">View Latest Coverage Report</a>
              </div>
            </div>
            
            <h3>Report History</h3>
            <p>See previous test reports:</p>
            <div class="list-group mb-4" id="report-list">
              <!-- Ð‘ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ JavaScript -->
            </div>
          </div>
          
          <script>
            // Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð²ÑÐµÑ… Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
            fetch('./reports/')
              .then(response => response.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                  .filter(a => !isNaN(a.textContent.trim()) && a.href.includes('/reports/'));
                
                const reportList = document.getElementById('report-list');
                
                links.sort((a, b) => {
                  return parseInt(b.textContent.trim()) - parseInt(a.textContent.trim());
                }).forEach(link => {
                  const runNumber = link.textContent.trim();
                  const listItem = document.createElement('a');
                  listItem.href = \`./reports/\${runNumber}/jest_html_reporters.html\`;
                  listItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');
                  listItem.innerHTML = \`
                    Run #\${runNumber}
                    <span>
                      <a href="./reports/\${runNumber}/coverage/lcov-report/index.html" class="btn btn-sm btn-outline-info ms-2">Coverage</a>
                    </span>
                  \`;
                  reportList.appendChild(listItem);
                });
                
                if (links.length === 0) {
                  reportList.innerHTML = '<div class="alert alert-info">No report history found</div>';
                }
              })
              .catch(error => {
                document.getElementById('report-list').innerHTML = 
                  \`<div class="alert alert-danger">Error loading report history: \${error.message}</div>\`;
              });
          </script>
        </body>
        </html>
        EOL
    
    - name: Deploy index page
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: .
        branch: gh-pages
        clean: false