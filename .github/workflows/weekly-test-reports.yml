# .github/workflows/weekly-test-reports.yml
name: Weekly Test Reports

on:
    schedule:
        # –ö–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É –≤ 18:00 UTC (21:00 –ø–æ –ö–∏–µ–≤—É)
        - cron: '0 18 * * 5'
    workflow_dispatch: # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    test-and-report:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Create reports directory
              run: mkdir -p reports/coverage reports/tests

            - name: Get previous coverage data
              run: |
                  # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á–µ—Ç —Å GitHub Pages
                  curl -f -s https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/coverage-summary.json > reports/previous-coverage.json || echo "{}" > reports/previous-coverage.json

            - name: Run tests with coverage
              continue-on-error: true
              run: |
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–∞–Ω–¥–∞ test:coverage –≤ package.json
                  if npm run | grep -q "test:coverage"; then
                    echo "Running test:coverage..."
                    npm run test:coverage
                  else
                    echo "test:coverage not found, trying alternatives..."
                    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å coverage
                    if npm run | grep -q "test"; then
                      if command -v jest >/dev/null 2>&1; then
                        echo "Running jest with coverage..."
                        npx jest --coverage --passWithNoTests
                      else
                        echo "Running npm test..."
                        npm test -- --coverage --passWithNoTests || npm test --passWithNoTests || echo "Tests failed or not configured"
                      fi
                    else
                      echo "No test command found"
                    fi
                  fi
                  
                  # –ö–æ–ø–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –≤ –ø–∞–ø–∫—É reports (–µ—Å–ª–∏ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç)
                  if [ -f coverage/coverage-summary.json ]; then
                    cp coverage/coverage-summary.json reports/
                    echo "Coverage summary copied"
                  else
                    echo "Coverage summary not found, creating empty one"
                    echo '{"total":{"lines":{"pct":0},"functions":{"pct":0},"branches":{"pct":0},"statements":{"pct":0}}}' > reports/coverage-summary.json
                  fi
                  
                  if [ -d coverage ]; then
                    cp -r coverage/* reports/coverage/
                    echo "Coverage directory copied"
                  else
                    echo "Coverage directory not found, creating placeholder"
                    mkdir -p reports/coverage
                    echo '<html><body><h1>No coverage data available</h1><p>Tests may not be configured to generate coverage reports.</p></body></html>' > reports/coverage/index.html
                  fi

            - name: Generate test report
              continue-on-error: true
              run: |
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–º–∞–Ω–¥–∞ test:report –≤ package.json
                  if npm run | grep -q "test:report"; then
                    echo "Running test:report..."
                    npm run test:report
                    # –ü–µ—Ä–µ–º–µ—â–∞–µ–º HTML –æ—Ç—á–µ—Ç –≤ –ø–∞–ø–∫—É reports
                    if [ -f test-report.html ]; then
                      mv test-report.html reports/tests/
                    fi
                  else
                    echo "test:report not found, creating basic test report..."
                    # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π HTML –æ—Ç—á–µ—Ç
                    cat > reports/tests/test-report.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Test Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Test Report</h1>
    <div class="info">
        <p>Test report generation is not configured in this project.</p>
        <p>To enable detailed test reports, add a test:report script to your package.json</p>
        <p>Example: <code>"test:report": "jest --coverage --reporters=default --reporters=jest-html-reporters"</code></p>
    </div>
    <p>Generated on: $(date)</p>
</body>
</html>
EOF
                  fi

            - name: Generate coverage trend analysis
              run: |
                  node -e "
                  const fs = require('fs');
                  const path = require('path');

                  // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
                  let currentCoverage = {};
                  try {
                    const data = fs.readFileSync('reports/coverage-summary.json', 'utf8');
                    currentCoverage = JSON.parse(data);
                    console.log('Current coverage data loaded');
                  } catch (e) {
                    console.log('No current coverage data found, using empty data');
                    currentCoverage = { total: { lines: { pct: 0 }, functions: { pct: 0 }, branches: { pct: 0 }, statements: { pct: 0 } } };
                  }

                  // –ß–∏—Ç–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
                  let previousCoverage = {};
                  try {
                    const data = fs.readFileSync('reports/previous-coverage.json', 'utf8');
                    previousCoverage = JSON.parse(data);
                    console.log('Previous coverage data loaded');
                  } catch (e) {
                    console.log('No previous coverage data found');
                    previousCoverage = { total: { lines: { pct: 0 }, functions: { pct: 0 }, branches: { pct: 0 }, statements: { pct: 0 } } };
                  }

                  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
                  function getCoveragePercent(coverage, type) {
                    return coverage.total && coverage.total[type] 
                      ? coverage.total[type].pct 
                      : 0;
                  }

                  // –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                  const current = {
                    lines: getCoveragePercent(currentCoverage, 'lines'),
                    functions: getCoveragePercent(currentCoverage, 'functions'),
                    branches: getCoveragePercent(currentCoverage, 'branches'),
                    statements: getCoveragePercent(currentCoverage, 'statements')
                  };

                  // –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                  const previous = {
                    lines: getCoveragePercent(previousCoverage, 'lines'),
                    functions: getCoveragePercent(previousCoverage, 'functions'),
                    branches: getCoveragePercent(previousCoverage, 'branches'),
                    statements: getCoveragePercent(previousCoverage, 'statements')
                  };

                  // –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–æ–≤
                  const trends = {
                    lines: current.lines - previous.lines,
                    functions: current.functions - previous.functions,
                    branches: current.branches - previous.branches,
                    statements: current.statements - previous.statements
                  };

                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
                  const hasData = current.lines > 0 || current.functions > 0 || current.branches > 0 || current.statements > 0;
                  
                  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞ –æ —Ç—Ä–µ–Ω–¥–∞—Ö
                  const trendHtml = \`
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>Test Coverage Trend Report</title>
                    <style>
                      body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                      .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                      .trend-positive { color: #28a745; font-weight: bold; }
                      .trend-negative { color: #dc3545; font-weight: bold; }
                      .trend-neutral { color: #6c757d; }
                      table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                      th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                      th { background-color: #f8f9fa; font-weight: bold; }
                      .date { font-size: 0.9em; color: #6c757d; margin-bottom: 20px; }
                      .warning { 
                        background: #fff3cd; 
                        border: 1px solid #ffeaa7; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 20px 0; 
                        color: #856404;
                      }
                      .links { margin-top: 30px; }
                      .links ul { list-style-type: none; padding: 0; }
                      .links li { margin: 10px 0; }
                      .links a { 
                        display: inline-block; 
                        padding: 10px 20px; 
                        background: #007bff; 
                        color: white; 
                        text-decoration: none; 
                        border-radius: 5px; 
                        transition: background 0.3s;
                      }
                      .links a:hover { background: #0056b3; }
                      h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                    </style>
                  </head>
                  <body>
                    <div class=\"container\">
                      <h1>üìä Test Coverage Trend Report</h1>
                      <p class=\"date\">Generated on: \${new Date().toLocaleString()}</p>
                      
                      \${!hasData ? '<div class=\"warning\"><strong>‚ö†Ô∏è No Coverage Data Available</strong><br>This project may not have tests configured or coverage reporting enabled.</div>' : ''}
                      
                      <table>
                        <tr>
                          <th>Metric</th>
                          <th>Current</th>
                          <th>Previous</th>
                          <th>Trend</th>
                        </tr>
                        <tr>
                          <td><strong>Lines</strong></td>
                          <td>\${current.lines.toFixed(2)}%</td>
                          <td>\${previous.lines.toFixed(2)}%</td>
                          <td class=\"\${trends.lines > 0 ? 'trend-positive' : trends.lines < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.lines > 0 ? '‚ÜóÔ∏è +' : trends.lines < 0 ? '‚ÜòÔ∏è ' : '‚û°Ô∏è '}\${trends.lines.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Functions</strong></td>
                          <td>\${current.functions.toFixed(2)}%</td>
                          <td>\${previous.functions.toFixed(2)}%</td>
                          <td class=\"\${trends.functions > 0 ? 'trend-positive' : trends.functions < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.functions > 0 ? '‚ÜóÔ∏è +' : trends.functions < 0 ? '‚ÜòÔ∏è ' : '‚û°Ô∏è '}\${trends.functions.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Branches</strong></td>
                          <td>\${current.branches.toFixed(2)}%</td>
                          <td>\${previous.branches.toFixed(2)}%</td>
                          <td class=\"\${trends.branches > 0 ? 'trend-positive' : trends.branches < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.branches > 0 ? '‚ÜóÔ∏è +' : trends.branches < 0 ? '‚ÜòÔ∏è ' : '‚û°Ô∏è '}\${trends.branches.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Statements</strong></td>
                          <td>\${current.statements.toFixed(2)}%</td>
                          <td>\${previous.statements.toFixed(2)}%</td>
                          <td class=\"\${trends.statements > 0 ? 'trend-positive' : trends.statements < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.statements > 0 ? '‚ÜóÔ∏è +' : trends.statements < 0 ? '‚ÜòÔ∏è ' : '‚û°Ô∏è '}\${trends.statements.toFixed(2)}%
                          </td>
                        </tr>
                      </table>
                      
                      <div class=\"links\">
                        <h2>üìã Reports</h2>
                        <ul>
                          <li><a href=\"./coverage/index.html\">üìà Detailed Coverage Report</a></li>
                          <li><a href=\"./tests/test-report.html\">üß™ Test Results</a></li>
                        </ul>
                      </div>
                      
                      \${!hasData ? '<div class=\"warning\"><strong>How to enable coverage:</strong><br>1. Add Jest or another test runner<br>2. Configure coverage in your test scripts<br>3. Add \"test:coverage\" script to package.json</div>' : ''}
                    </div>
                  </body>
                  </html>
                  \`;

                  fs.writeFileSync('reports/index.html', trendHtml);
                  console.log('‚úÖ Trend report generated successfully');
                  console.log('Coverage data:', { current, previous, trends });
                  "

            - name: Create fallback files
              run: |
                  # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                  if [ ! -f reports/coverage/index.html ]; then
                    mkdir -p reports/coverage
                    echo '<html><body><h1>Coverage Report Not Available</h1><p>No coverage data was generated. Configure your tests to generate coverage reports.</p></body></html>' > reports/coverage/index.html
                  fi
                  
                  if [ ! -f reports/tests/test-report.html ]; then
                    mkdir -p reports/tests
                    echo '<html><body><h1>Test Report Not Available</h1><p>No test report was generated. Configure your test runner to generate HTML reports.</p></body></html>' > reports/tests/test-report.html
                  fi

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: './reports'

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4