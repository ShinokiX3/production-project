# .github/workflows/weekly-test-reports.yml
name: Weekly Test Reports

on:
    schedule:
        # Каждую пятницу в 18:00 UTC (21:00 по Киеву)
        - cron: '0 18 * * 5'
    workflow_dispatch: # Возможность запустить вручную

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    test-and-report:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Получаем всю историю для сравнения

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Create reports directory
              run: mkdir -p reports/coverage reports/tests

            - name: Get previous coverage data
              run: |
                  # Пытаемся получить предыдущий отчет с GitHub Pages
                  curl -f -s https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/coverage-summary.json > reports/previous-coverage.json || echo "{}" > reports/previous-coverage.json

            - name: Run tests with coverage
              continue-on-error: true
              run: |
                  # Проверяем, есть ли команда test:coverage в package.json
                  if npm run | grep -q "test:coverage"; then
                    echo "Running test:coverage..."
                    npm run test:coverage
                  else
                    echo "test:coverage not found, trying alternatives..."
                    # Пробуем различные варианты запуска тестов с coverage
                    if npm run | grep -q "test"; then
                      if command -v jest >/dev/null 2>&1; then
                        echo "Running jest with coverage..."
                        npx jest --coverage --passWithNoTests
                      else
                        echo "Running npm test..."
                        npm test -- --coverage --passWithNoTests || npm test --passWithNoTests || echo "Tests failed or not configured"
                      fi
                    else
                      echo "No test command found"
                    fi
                  fi
                  
                  # Копируем отчет о покрытии в папку reports (если файлы существуют)
                  if [ -f coverage/coverage-summary.json ]; then
                    cp coverage/coverage-summary.json reports/
                    echo "Coverage summary copied"
                  else
                    echo "Coverage summary not found, creating empty one"
                    echo '{"total":{"lines":{"pct":0},"functions":{"pct":0},"branches":{"pct":0},"statements":{"pct":0}}}' > reports/coverage-summary.json
                  fi
                  
                  if [ -d coverage ]; then
                    cp -r coverage/* reports/coverage/
                    echo "Coverage directory copied"
                  else
                    echo "Coverage directory not found, creating placeholder"
                    mkdir -p reports/coverage
                    echo '<html><body><h1>No coverage data available</h1><p>Tests may not be configured to generate coverage reports.</p></body></html>' > reports/coverage/index.html
                  fi

            - name: Generate test report
              continue-on-error: true
              run: |
                  # Проверяем, есть ли команда test:report в package.json
                  if npm run | grep -q "test:report"; then
                    echo "Running test:report..."
                    npm run test:report
                    # Перемещаем HTML отчет в папку reports
                    if [ -f test-report.html ]; then
                      mv test-report.html reports/tests/
                    fi
                  else
                    echo "test:report not found, creating basic test report..."
                    # Создаем базовый HTML отчет
                    cat > reports/tests/test-report.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Test Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Test Report</h1>
    <div class="info">
        <p>Test report generation is not configured in this project.</p>
        <p>To enable detailed test reports, add a test:report script to your package.json</p>
        <p>Example: <code>"test:report": "jest --coverage --reporters=default --reporters=jest-html-reporters"</code></p>
    </div>
    <p>Generated on: $(date)</p>
</body>
</html>
EOF
                  fi

            - name: Generate coverage trend analysis
              run: |
                  node -e "
                  const fs = require('fs');
                  const path = require('path');

                  // Читаем текущее покрытие
                  let currentCoverage = {};
                  try {
                    const data = fs.readFileSync('reports/coverage-summary.json', 'utf8');
                    currentCoverage = JSON.parse(data);
                    console.log('Current coverage data loaded');
                  } catch (e) {
                    console.log('No current coverage data found, using empty data');
                    currentCoverage = { total: { lines: { pct: 0 }, functions: { pct: 0 }, branches: { pct: 0 }, statements: { pct: 0 } } };
                  }

                  // Читаем предыдущее покрытие
                  let previousCoverage = {};
                  try {
                    const data = fs.readFileSync('reports/previous-coverage.json', 'utf8');
                    previousCoverage = JSON.parse(data);
                    console.log('Previous coverage data loaded');
                  } catch (e) {
                    console.log('No previous coverage data found');
                    previousCoverage = { total: { lines: { pct: 0 }, functions: { pct: 0 }, branches: { pct: 0 }, statements: { pct: 0 } } };
                  }

                  // Функция для расчета процента покрытия
                  function getCoveragePercent(coverage, type) {
                    return coverage.total && coverage.total[type] 
                      ? coverage.total[type].pct 
                      : 0;
                  }

                  // Текущие показатели
                  const current = {
                    lines: getCoveragePercent(currentCoverage, 'lines'),
                    functions: getCoveragePercent(currentCoverage, 'functions'),
                    branches: getCoveragePercent(currentCoverage, 'branches'),
                    statements: getCoveragePercent(currentCoverage, 'statements')
                  };

                  // Предыдущие показатели
                  const previous = {
                    lines: getCoveragePercent(previousCoverage, 'lines'),
                    functions: getCoveragePercent(previousCoverage, 'functions'),
                    branches: getCoveragePercent(previousCoverage, 'branches'),
                    statements: getCoveragePercent(previousCoverage, 'statements')
                  };

                  // Расчет трендов
                  const trends = {
                    lines: current.lines - previous.lines,
                    functions: current.functions - previous.functions,
                    branches: current.branches - previous.branches,
                    statements: current.statements - previous.statements
                  };

                  // Проверяем, есть ли данные о покрытии
                  const hasData = current.lines > 0 || current.functions > 0 || current.branches > 0 || current.statements > 0;
                  
                  // Генерация HTML отчета о трендах
                  const trendHtml = \`
                  <!DOCTYPE html>
                  <html>
                  <head>
                    <title>Test Coverage Trend Report</title>
                    <style>
                      body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                      .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                      .trend-positive { color: #28a745; font-weight: bold; }
                      .trend-negative { color: #dc3545; font-weight: bold; }
                      .trend-neutral { color: #6c757d; }
                      table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                      th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                      th { background-color: #f8f9fa; font-weight: bold; }
                      .date { font-size: 0.9em; color: #6c757d; margin-bottom: 20px; }
                      .warning { 
                        background: #fff3cd; 
                        border: 1px solid #ffeaa7; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 20px 0; 
                        color: #856404;
                      }
                      .links { margin-top: 30px; }
                      .links ul { list-style-type: none; padding: 0; }
                      .links li { margin: 10px 0; }
                      .links a { 
                        display: inline-block; 
                        padding: 10px 20px; 
                        background: #007bff; 
                        color: white; 
                        text-decoration: none; 
                        border-radius: 5px; 
                        transition: background 0.3s;
                      }
                      .links a:hover { background: #0056b3; }
                      h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                    </style>
                  </head>
                  <body>
                    <div class=\"container\">
                      <h1>📊 Test Coverage Trend Report</h1>
                      <p class=\"date\">Generated on: \${new Date().toLocaleString()}</p>
                      
                      \${!hasData ? '<div class=\"warning\"><strong>⚠️ No Coverage Data Available</strong><br>This project may not have tests configured or coverage reporting enabled.</div>' : ''}
                      
                      <table>
                        <tr>
                          <th>Metric</th>
                          <th>Current</th>
                          <th>Previous</th>
                          <th>Trend</th>
                        </tr>
                        <tr>
                          <td><strong>Lines</strong></td>
                          <td>\${current.lines.toFixed(2)}%</td>
                          <td>\${previous.lines.toFixed(2)}%</td>
                          <td class=\"\${trends.lines > 0 ? 'trend-positive' : trends.lines < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.lines > 0 ? '↗️ +' : trends.lines < 0 ? '↘️ ' : '➡️ '}\${trends.lines.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Functions</strong></td>
                          <td>\${current.functions.toFixed(2)}%</td>
                          <td>\${previous.functions.toFixed(2)}%</td>
                          <td class=\"\${trends.functions > 0 ? 'trend-positive' : trends.functions < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.functions > 0 ? '↗️ +' : trends.functions < 0 ? '↘️ ' : '➡️ '}\${trends.functions.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Branches</strong></td>
                          <td>\${current.branches.toFixed(2)}%</td>
                          <td>\${previous.branches.toFixed(2)}%</td>
                          <td class=\"\${trends.branches > 0 ? 'trend-positive' : trends.branches < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.branches > 0 ? '↗️ +' : trends.branches < 0 ? '↘️ ' : '➡️ '}\${trends.branches.toFixed(2)}%
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Statements</strong></td>
                          <td>\${current.statements.toFixed(2)}%</td>
                          <td>\${previous.statements.toFixed(2)}%</td>
                          <td class=\"\${trends.statements > 0 ? 'trend-positive' : trends.statements < 0 ? 'trend-negative' : 'trend-neutral'}\">
                            \${trends.statements > 0 ? '↗️ +' : trends.statements < 0 ? '↘️ ' : '➡️ '}\${trends.statements.toFixed(2)}%
                          </td>
                        </tr>
                      </table>
                      
                      <div class=\"links\">
                        <h2>📋 Reports</h2>
                        <ul>
                          <li><a href=\"./coverage/index.html\">📈 Detailed Coverage Report</a></li>
                          <li><a href=\"./tests/test-report.html\">🧪 Test Results</a></li>
                        </ul>
                      </div>
                      
                      \${!hasData ? '<div class=\"warning\"><strong>How to enable coverage:</strong><br>1. Add Jest or another test runner<br>2. Configure coverage in your test scripts<br>3. Add \"test:coverage\" script to package.json</div>' : ''}
                    </div>
                  </body>
                  </html>
                  \`;

                  fs.writeFileSync('reports/index.html', trendHtml);
                  console.log('✅ Trend report generated successfully');
                  console.log('Coverage data:', { current, previous, trends });
                  "

            - name: Create fallback files
              run: |
                  # Убеждаемся, что все необходимые файлы существуют
                  if [ ! -f reports/coverage/index.html ]; then
                    mkdir -p reports/coverage
                    echo '<html><body><h1>Coverage Report Not Available</h1><p>No coverage data was generated. Configure your tests to generate coverage reports.</p></body></html>' > reports/coverage/index.html
                  fi
                  
                  if [ ! -f reports/tests/test-report.html ]; then
                    mkdir -p reports/tests
                    echo '<html><body><h1>Test Report Not Available</h1><p>No test report was generated. Configure your test runner to generate HTML reports.</p></body></html>' > reports/tests/test-report.html
                  fi

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: './reports'

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4